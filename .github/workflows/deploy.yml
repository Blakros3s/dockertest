name: Deploy to VPS (Docker Compose)

on:
  # Trigger after CI workflow completes successfully
  workflow_run:
    workflows: ["CI â€“ Lint & Test (No Docker Runtime)"]
    types:
      - completed

jobs:
  deploy:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'

    name: Deploy on VPS
    runs-on: ubuntu-latest

    # Prevent multiple deployments from running simultaneously
    concurrency:
      group: deploy-uat
      cancel-in-progress: false

    steps:
      #- name: Test SSH login with retries (passphrase protected key)
      #  run: |
      #    echo "ğŸ”‘ Setting up SSH key..."
      #    mkdir -p ~/.ssh
      #    echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
      #    chmod 600 ~/.ssh/id_rsa

      #    echo "ğŸ”‘ Starting ssh-agent and adding key with passphrase..."
      #    eval "$(ssh-agent -s)"
      #    # Feed both the key and the passphrase into ssh-add
      #    echo "${{ secrets.SSH_PASSPHRASE }}" | SSH_ASKPASS=/bin/cat ssh-add ~/.ssh/id_rsa

      #    echo "ğŸ”‘ Testing SSH login..."
      #    SUCCESS=false
      #    for i in 1 2 3 4 5; do
      #      if ssh -o StrictHostKeyChecking=no \
      #          -o ConnectTimeout=10 \
      #          -p ${{ secrets.SSH_PORT }} \
      #          ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "echo âœ… SSH login successful"; then
      #        SUCCESS=true
      #        break
      #      fi
      #      echo "âŒ Attempt $i failed, retrying in 10s..."
      #      sleep 10
      #    done

      #    if [ "$SUCCESS" = false ]; then
      #      echo "ğŸš¨ Failed to connect to VPS after 5 attempts."
      #      exit 1
      #    fi


      - name: Safe Deploy via SSH
        uses: appleboy/ssh-action@v1.2.5
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          timeout: 60s
          command_timeout: 20m
          script: |
            set -e

            CURRENT_COMMIT=""

            rollback() {
              echo "ğŸš¨ Deployment failed â€” rolling back..."
              
              # Revert code changes
              if [ -n "$CURRENT_COMMIT" ]; then
                cd /srv/dockertest
                git reset --hard $CURRENT_COMMIT
                echo "ğŸ”™ Reverted to commit: $CURRENT_COMMIT"
              fi
              
              # Restart old containers
              cd /srv/dockertest/docker
              docker compose -f docker-compose.base.yml -f docker-compose.uat.yml down
              docker compose -f docker-compose.base.yml -f docker-compose.uat.yml up -d
              
              echo "ğŸ” Rollback completed"
            }

            trap rollback ERR

            exec > /srv/logs/dockertest/deploy-$(date +"%F_%T").log 2>&1

            echo "ğŸš€ Deployment started at $(date)"

            cd /srv/dockertest

            # Extract DB credentials from .env
            if [ -f "docker/.env" ]; then
              export $(grep -E '^(POSTGRES_USER|POSTGRES_DB)=' docker/.env | xargs)
              echo "âœ… Extracted DB credentials from docker/.env"
            else
              echo "âš ï¸ docker/.env not found"
            fi

            # Save current commit for rollback
            CURRENT_COMMIT=$(git rev-parse HEAD)
            echo "ğŸ“Œ Current commit: $CURRENT_COMMIT"

            echo "ğŸ” Validating environment files..."
            REQUIRED_FILES=(
              "docker/.env"
              "backend/.env.uat"
              "frontend/.env.production"
            )

            for file in "${REQUIRED_FILES[@]}"; do
              if [ ! -f "$file" ]; then
                echo "âŒ Missing required file: $file"
                exit 1
              fi
            done
            echo "âœ… Environment validation passed"

            echo "ğŸ—„ï¸ Backing up database..."
            BACKUP_DIR="/srv/backups/dockertest/"
            TIMESTAMP=$(date +"%F_%H-%M-%S")

            cd docker
            # Use extracted variables for backup
            docker compose -f docker-compose.base.yml -f docker-compose.uat.yml exec -T db \
              pg_dump -U "$POSTGRES_USER" "$POSTGRES_DB" \
              > "$BACKUP_DIR/db_$TIMESTAMP.sql"

            echo "âœ… Database backup created: db_$TIMESTAMP.sql"

            # Keep only last 7 days of backups
            find "$BACKUP_DIR" -name "db_*.sql" -mtime +7 -delete
            echo "ğŸ§¹ Cleaned up old backups (kept last 7 days)"

            cd /srv/dockertest

            echo "ğŸ“¥ Pulling latest code..."
            git fetch origin
            git reset --hard origin/main

            cd docker

            echo "ğŸ³ Building images on VPS..."
            docker compose -f docker-compose.base.yml -f docker-compose.uat.yml build

            echo "ğŸš€ Starting new containers..."
            docker compose -f docker-compose.base.yml -f docker-compose.uat.yml up -d

            echo "â³ Waiting for containers to start..."
            sleep 15

            echo "ğŸ” Checking container status..."
            CONTAINER_STATUS=$(docker compose -f docker-compose.base.yml -f docker-compose.uat.yml ps --format json | jq -r '.[].State' | grep -v "running" || true)

            if [ -n "$CONTAINER_STATUS" ]; then
              echo "âŒ Some containers are not running:"
              docker compose -f docker-compose.base.yml -f docker-compose.uat.yml ps
              exit 1
            fi

            echo "âœ… All containers are running"

            echo "ğŸ“Š Final container status:"
            docker compose -f docker-compose.base.yml -f docker-compose.uat.yml ps

            echo "âœ… Deployment completed successfully at $(date)"
